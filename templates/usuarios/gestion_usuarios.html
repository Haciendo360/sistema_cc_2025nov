{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            </select>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="is_active" name="is_active">
                <label class="form-check-label" for="is_active">
                    Usuario Activo (Puede ingresar a la plataforma)
                </label>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="is_staff" name="is_staff">
                <label class="form-check-label" for="is_staff">
                    Personal del Sistema
                </label>
            </div>
        </div>
    </div>
</div>

<div class="form-group">
    <label for="observaciones_aprobacion">Observaciones:</label>
    <textarea class="form-control" id="observaciones_aprobacion" name="observaciones_aprobacion" rows="3"></textarea>
</div>
</form>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
    <button type="button" class="btn btn-primary" onclick="guardarUsuario()">Guardar Cambios</button>
</div>
</div>
</div>
</div>

<script>
    function editarUsuario(usuarioId) {
        // Cargar datos del usuario
        fetch(`/usuarios/api/usuario/${usuarioId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('usuario_id').value = data.id;
                document.getElementById('username').value = data.username;
                document.getElementById('email').value = data.email;
                document.getElementById('first_name').value = data.first_name;
                document.getElementById('last_name').value = data.last_name;
                document.getElementById('cedula').value = data.cedula;
                document.getElementById('telefono').value = data.telefono;
                document.getElementById('direccion').value = data.direccion;
                document.getElementById('rol').value = data.rol;
                document.getElementById('estado_aprobacion').value = data.estado_aprobacion;
                document.getElementById('is_active').checked = data.is_active;
                document.getElementById('is_staff').checked = data.is_staff;
                document.getElementById('observaciones_aprobacion').value = data.observaciones_aprobacion || '';

                $('#modalEditarUsuario').modal('show');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los datos del usuario');
            });
    }

    function guardarUsuario() {
        const formData = new FormData(document.getElementById('formEditarUsuario'));
        const usuarioId = formData.get('usuario_id');

        fetch(`/usuarios/api/usuario/${usuarioId}/editar/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#modalEditarUsuario').modal('hide');
                    location.reload(); // Recargar la página para ver los cambios
                } else {
                    alert('Error al guardar: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar los cambios');
            });
    }


    function confirmarEliminar(usuarioId, username) {
        document.getElementById('eliminar_username').textContent = username;
        document.getElementById('formEliminarUsuario').action = `/usuarios/gestion/eliminar/${usuarioId}/`;
        $('#modalEliminarUsuario').modal('show');
    }
</script>
{% endblock %}